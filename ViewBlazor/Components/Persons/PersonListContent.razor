@using ViewBlazor.Components.Commons.Fields
@using Model.ViewModels
@using ViewModel.Persons
@using System.ComponentModel
@implements IDisposable

<h1>@ViewModel.Title</h1>

<div class="mb-3">
    <CommandView Command="@ViewModel.SaveCommand" />
    <CommandView Command="@ViewModel.DiscardCommand" />
</div>

@if (ViewModel.ValidationErrors != null && ViewModel.ValidationErrors.Any())
{
    <div class="alert alert-danger">
        <h5>Validation Errors:</h5>
        @foreach (var group in ViewModel.ValidationErrors.GroupBy(e => e.ViewModel))
        {
            <div class="mb-2">
                <strong>@group.Key?.ToString()</strong>
                <ul>
                    @foreach (var error in group)
                    {
                        <li>@error.PropertyName: @error.ErrorMessage</li>
                    }
                </ul>
            </div>
        }
    </div>
}

@if (!string.IsNullOrEmpty(ViewModel.StatusMessage))
{
    <div class="alert alert-success">
        @ViewModel.StatusMessage
    </div>
}

<div class="row">
    <div class="col-md-6">
        <CollectionFieldView T="PersonViewModel"
                             Field="@ViewModel.Persons"
                             SelectedItemChanged="@OnPersonSelected"
                             EmptyMessage="No persons found" />
    </div>

    <div class="col-md-6">
        @if (ViewModel.SelectedPerson != null)
        {
            <PersonView ViewModel="@ViewModel.SelectedPerson" />
        }
        else
        {
            <p class="text-muted">Select a person to view details</p>
        }
    </div>
</div>

@code {
    [Parameter]
    public PersonListViewModel ViewModel { get; set; } = null!;

    protected override void OnInitialized()
    {
        ViewModel.PropertyChanged += OnViewModelPropertyChanged;
    }

    private void OnViewModelPropertyChanged(object? sender, PropertyChangedEventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    private void OnPersonSelected(PersonViewModel? person)
    {
        ViewModel.SelectedPerson = person;
    }

    public void Dispose()
    {
        ViewModel.PropertyChanged -= OnViewModelPropertyChanged;
    }
}
