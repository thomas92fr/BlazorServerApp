@typeparam T where T : class
@using ViewModel.Commons.Fields
@using BlazorServerApp.Model.ViewModels
@using System.Reflection
@inject TooltipService TooltipService
@implements IDisposable

<div class="rz-mb-3">
    @if (!string.IsNullOrEmpty(Field?.Label))
    {
        <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-mb-2">@Field.Label</RadzenText>
    }

    @* Toolbar *@
    @if (Field != null && (Field.AllowAdd || Field.AllowMultiSelect || ShowRefresh))
    {
        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" class="rz-mb-2" Wrap="FlexWrap.Wrap">
            @if (Field.AllowAdd)
            {
                <CommandView Command="@Field.AddCommand" />
            }
            @if (Field.AllowMultiSelect && Field.AllowDelete && Field.SelectedCount > 0)
            {
                <CommandView Command="@Field.DeleteSelectedCommand" />
            }
            @if (Field.AllowMultiSelect && Field.SelectedCount > 0)
            {
                <RadzenButton Text="@($"Clear ({Field.SelectedCount})")"
                              ButtonStyle="ButtonStyle.Light"
                              Size="ButtonSize.Small"
                              Click="ClearSelection" />
            }
            @if (ShowRefresh)
            {
                <CommandView Command="@Field.RefreshCommand" />
            }
        </RadzenStack>
    }

    @* RadzenDataGrid *@
    <RadzenDataGrid @ref="grid"
                    TItem="T"
                    Data="@Field?.Collection"
                    SelectionMode="@GetSelectionMode()"
                    Value="@selectedItems"
                    ValueChanged="@OnSelectionChanged"
                    AllowSorting="true"
                    AllowColumnResize="true"
                    ShowCheckBoxColumn="@(Field?.AllowMultiSelect == true)"
                    class="@TableCssClass">
        <EmptyTemplate>
            <RadzenText TextStyle="TextStyle.Body2" class="rz-text-align-center rz-p-4">
                @EmptyMessage
            </RadzenText>
        </EmptyTemplate>
        <Columns>
            @if (Field?.ColumnProperties != null)
            {
                @foreach (var prop in Field.ColumnProperties)
                {
                    var fieldMeta = GetFieldMetadata(prop);
                    <RadzenDataGridColumn TItem="T"
                                          Title="@fieldMeta.Label"
                                          Width="@fieldMeta.Width"
                                          Property="@($"{prop.Name}.Value")"
                                          Sortable="true">
                        <Template Context="item">
                            @GetFieldValueFromProperty(item, prop)
                        </Template>
                    </RadzenDataGridColumn>
                }
            }
            @if (Field?.AllowDelete == true || ShowActions)
            {
                <RadzenDataGridColumn TItem="T" Title="Actions" Width="80px" Sortable="false" Filterable="false">
                    <Template Context="item">
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.25rem">
                            @if (Field?.AllowDelete == true)
                            {
                                <RadzenButton Icon="delete"
                                              ButtonStyle="ButtonStyle.Danger"
                                              Variant="Variant.Text"
                                              Size="ButtonSize.Small"
                                              Click="() => DeleteItem(item)"
                                              MouseEnter="@(args => TooltipService.Open(args, "Delete"))" />
                            }
                            @if (RowActions != null)
                            {
                                @RowActions(item)
                            }
                        </RadzenStack>
                    </Template>
                </RadzenDataGridColumn>
            }
        </Columns>
    </RadzenDataGrid>

    @* Validation Messages *@
    @if (!string.IsNullOrEmpty(Field?.Error))
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" Shade="Shade.Lighter" Size="AlertSize.Small" class="rz-mt-2">
            @Field.Error
        </RadzenAlert>
    }
    @if (!string.IsNullOrEmpty(Field?.Warning))
    {
        <RadzenAlert AlertStyle="AlertStyle.Warning" Shade="Shade.Lighter" Size="AlertSize.Small" class="rz-mt-2">
            @Field.Warning
        </RadzenAlert>
    }
    @if (!string.IsNullOrEmpty(Field?.Hint))
    {
        <RadzenText TextStyle="TextStyle.Caption" class="rz-mt-1">@Field.Hint</RadzenText>
    }

    @* Item Count *@
    @if (ShowCount && Field != null)
    {
        <RadzenText TextStyle="TextStyle.Caption" class="rz-mt-1">
            @Field.Count item(s)
            @if (Field.AllowMultiSelect && Field.SelectedCount > 0)
            {
                <span> - @Field.SelectedCount selected</span>
            }
        </RadzenText>
    }
</div>

@code {
    private RadzenDataGrid<T>? grid;
    private CollectionFieldViewModel<T>? _previousField;
    private IList<T>? selectedItems = new List<T>();
    private bool _isSyncing = false;

    [Parameter]
    public CollectionFieldViewModel<T>? Field { get; set; }

    [Parameter]
    public string? TableCssClass { get; set; }

    [Parameter]
    public bool ShowRefresh { get; set; } = false;

    [Parameter]
    public bool ShowActions { get; set; } = false;

    [Parameter]
    public bool ShowCount { get; set; } = true;

    [Parameter]
    public string EmptyMessage { get; set; } = "No items";

    /// <summary>
    /// Optional custom actions per row.
    /// </summary>
    [Parameter]
    public RenderFragment<T>? RowActions { get; set; }

    /// <summary>
    /// Event callback when single selection changes.
    /// </summary>
    [Parameter]
    public EventCallback<T?> SelectedItemChanged { get; set; }

    /// <summary>
    /// Event callback when multi-selection changes.
    /// </summary>
    [Parameter]
    public EventCallback<IReadOnlyList<T>> SelectedItemsChanged { get; set; }

    protected override void OnParametersSet()
    {
        if (_previousField != Field)
        {
            if (_previousField != null)
            {
                _previousField.PropertyChanged -= OnFieldPropertyChanged;
            }
            if (Field != null)
            {
                Field.PropertyChanged += OnFieldPropertyChanged;
                SyncSelectionFromViewModel();
            }
            _previousField = Field;
        }
    }

    private void OnFieldPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        // Ignore selection changes while we're syncing to avoid loops
        if (_isSyncing) return;

        if (e.PropertyName == nameof(Field.SelectedItem) ||
            e.PropertyName == nameof(Field.SelectedItems) ||
            e.PropertyName == nameof(Field.SelectedCount))
        {
            SyncSelectionFromViewModel();
        }
        InvokeAsync(StateHasChanged);
    }

    private void SyncSelectionFromViewModel()
    {
        if (Field == null) return;

        if (Field.AllowMultiSelect)
        {
            selectedItems = Field.SelectedItems.ToList();
        }
        else if (Field.SelectedItem != null)
        {
            selectedItems = new List<T> { Field.SelectedItem };
        }
        else
        {
            selectedItems = new List<T>();
        }
    }

    private DataGridSelectionMode GetSelectionMode()
    {
        return Field?.AllowMultiSelect == true
            ? DataGridSelectionMode.Multiple
            : DataGridSelectionMode.Single;
    }

    private void OnSelectionChanged(IList<T>? newSelection)
    {
        selectedItems = newSelection ?? new List<T>();

        if (Field == null) return;

        try
        {
            _isSyncing = true;

            // Sync selection to ViewModel
            Field.ClearSelection();
            foreach (var item in selectedItems)
            {
                Field.ToggleSelection(item);
            }
        }
        finally
        {
            _isSyncing = false;
        }

        // Notify parent components
        var lastSelected = selectedItems.LastOrDefault();
        if (lastSelected != null)
        {
            SelectedItemChanged.InvokeAsync(lastSelected);
        }

        if (Field.AllowMultiSelect)
        {
            SelectedItemsChanged.InvokeAsync(Field.SelectedItems.ToList());
        }
    }

    private void ClearSelection()
    {
        try
        {
            _isSyncing = true;
            Field?.ClearSelection();
            selectedItems = new List<T>();
        }
        finally
        {
            _isSyncing = false;
        }
    }

    private void DeleteItem(T item)
    {
        Field?.DeleteCommand.Command.Execute(item);
    }

    private (string Label, string? Width) GetFieldMetadata(PropertyInfo prop)
    {
        if (Field?.Collection.FirstOrDefault() is T firstItem)
        {
            var fieldVm = prop.GetValue(firstItem) as IFieldViewModel;
            if (fieldVm != null)
            {
                return (fieldVm.Label ?? prop.Name, fieldVm.ColumnWidth);
            }
        }
        return (prop.Name, null);
    }

    private string GetFieldValueFromProperty(T item, PropertyInfo prop)
    {
        var fieldVm = prop.GetValue(item) as IFieldViewModel;
        if (fieldVm != null)
        {
            var valueProperty = fieldVm.GetType().GetProperty("Value");
            var value = valueProperty?.GetValue(fieldVm);
            return value?.ToString() ?? string.Empty;
        }
        return string.Empty;
    }

    public void Dispose()
    {
        if (Field != null)
        {
            Field.PropertyChanged -= OnFieldPropertyChanged;
        }
    }
}
