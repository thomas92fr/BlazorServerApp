@typeparam T
@using BlazorServerApp.ViewModel.Commons.Fields
@inject TooltipService TooltipService

@if (ElementType == "link")
{
    @if (ChildContent != null)
    {
        <RadzenButton Click="ExecuteCommand"
                      ButtonStyle="@GetButtonStyle()"
                      Variant="Variant.Text"
                      Disabled="@IsDisabled()"
                      IsBusy="@(Command?.IsBusy ?? false)"
                      MouseEnter="@ShowTooltip"
                      class="@CssClass">
            @ChildContent
        </RadzenButton>
    }
    else
    {
        <RadzenButton Click="ExecuteCommand"
                      Text="@Command?.Text"
                      ButtonStyle="@GetButtonStyle()"
                      Variant="Variant.Text"
                      Disabled="@IsDisabled()"
                      IsBusy="@(Command?.IsBusy ?? false)"
                      MouseEnter="@ShowTooltip"
                      class="@CssClass" />
    }
}
else
{
    @if (ChildContent != null)
    {
        <RadzenButton Click="ExecuteCommand"
                      ButtonStyle="@GetButtonStyle()"
                      Disabled="@IsDisabled()"
                      IsBusy="@(Command?.IsBusy ?? false)"
                      MouseEnter="@ShowTooltip"
                      class="@CssClass">
            @ChildContent
        </RadzenButton>
    }
    else
    {
        <RadzenButton Click="ExecuteCommand"
                      Text="@Command?.Text"
                      ButtonStyle="@GetButtonStyle()"
                      Disabled="@IsDisabled()"
                      IsBusy="@(Command?.IsBusy ?? false)"
                      MouseEnter="@ShowTooltip"
                      class="@CssClass" />
    }
}

@code {
    /// <summary>
    /// The command to execute with a parameter of type T.
    /// </summary>
    [Parameter]
    public ICommandViewModel<T>? Command { get; set; }

    /// <summary>
    /// The parameter to pass to the command when executed.
    /// </summary>
    [Parameter]
    public T? Parameter { get; set; }

    /// <summary>
    /// Optional CSS class to override the adaptive styling.
    /// </summary>
    [Parameter]
    public string? CssClass { get; set; }

    /// <summary>
    /// The type of HTML element to render ("button" or "link").
    /// Default is "button".
    /// </summary>
    [Parameter]
    public string ElementType { get; set; } = "button";

    /// <summary>
    /// Optional child content for custom display.
    /// If provided, this will be displayed instead of Command.Text.
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// Executes the command with the provided parameter.
    /// </summary>
    private void ExecuteCommand()
    {
        Command?.Command.Execute(Parameter);
    }

    /// <summary>
    /// Returns true if the element should be disabled.
    /// </summary>
    private bool IsDisabled()
    {
        return Command?.IsBusy == true || Command?.IsEnabled == false;
    }

    /// <summary>
    /// Shows tooltip with the command hint on mouse enter.
    /// </summary>
    private void ShowTooltip(ElementReference elementReference)
    {
        if (!string.IsNullOrEmpty(Command?.Hint))
        {
            TooltipService.Open(elementReference, Command.Hint);
        }
    }

    /// <summary>
    /// Gets the Radzen ButtonStyle based on Command.Style.
    /// </summary>
    private ButtonStyle GetButtonStyle()
    {
        return (Command?.Style ?? CommandStyle.Default) switch
        {
            CommandStyle.Primary => ButtonStyle.Primary,
            CommandStyle.Success => ButtonStyle.Success,
            CommandStyle.Danger => ButtonStyle.Danger,
            CommandStyle.Warning => ButtonStyle.Warning,
            CommandStyle.Info => ButtonStyle.Info,
            CommandStyle.Light => ButtonStyle.Light,
            CommandStyle.Dark => ButtonStyle.Dark,
            _ => ButtonStyle.Secondary
        };
    }
}
