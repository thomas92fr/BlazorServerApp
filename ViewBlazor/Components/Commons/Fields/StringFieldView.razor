@using ViewModel.Commons.Fields
@inject TooltipService TooltipService

<RadzenFormField Text="@Field?.Label" Variant="Variant.Outlined" class="rz-mb-3 w-100">
    <End>
        <div style="display: flex; align-items: center; height: 100%;">
            @if (!string.IsNullOrEmpty(Field?.Hint))
            {
                <RadzenIcon Icon="info" Style="cursor: help; color: var(--rz-text-tertiary-color);"
                            MouseEnter="@(args => ShowHintTooltip(args))" />
            }
        </div>
    </End>
    <ChildContent>
        @if (Field?.List != null && Field.ValueMustBeInTheList)
        {
            @* Strict select mode: only values from list allowed *@
            <RadzenDropDown TValue="string"
                            Data="@Field.List"
                            Value="@Field.Value"
                            ValueChanged="@OnValueChanged"
                            Disabled="@(Field?.ReadOnly ?? false)"
                            AllowClear="true"
                            AllowFiltering="true"
                            FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                            Style="width: 100%;" />
        }
        else if (Field?.List != null)
        {
            @* Combo mode: free input with autocomplete suggestions *@
            <RadzenAutoComplete Data="@Field.List"
                                Value="@Field.Value"
                                Change="@(args => OnValueChanged(args?.ToString()))"
                                Disabled="@(Field?.ReadOnly ?? false)"
                                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                Style="width: 100%;" />
        }
        else
        {
            @* Free input mode *@
            <RadzenTextBox Value="@Field?.Value"
                           ValueChanged="@OnValueChanged"
                           Disabled="@(Field?.ReadOnly ?? false)"
                           Style="width: 100%;" />
        }
    </ChildContent>
</RadzenFormField>

@if (!string.IsNullOrEmpty(Field?.Error))
{
    <RadzenAlert AlertStyle="AlertStyle.Danger"
                 Shade="Shade.Lighter"
                 Size="AlertSize.Small"
                 AllowClose="false"
                 class="rz-mt-1">
        @Field.Error
    </RadzenAlert>
}

@if (!string.IsNullOrEmpty(Field?.Warning))
{
    <RadzenAlert AlertStyle="AlertStyle.Warning"
                 Shade="Shade.Lighter"
                 Size="AlertSize.Small"
                 AllowClose="false"
                 class="rz-mt-1">
        @Field.Warning
    </RadzenAlert>
}

@code {
    [Parameter]
    public StringFieldViewModel? Field { get; set; }

    [Parameter]
    public EventCallback<string> ValueChanged { get; set; }

    private async Task OnValueChanged(string? value)
    {
        if (Field != null)
        {
            Field.Value = value ?? string.Empty;
            await ValueChanged.InvokeAsync(value ?? string.Empty);
        }
    }

    private void ShowHintTooltip(ElementReference elementReference)
    {
        if (!string.IsNullOrEmpty(Field?.Hint))
        {
            TooltipService.Open(elementReference, Field.Hint);
        }
    }
}
