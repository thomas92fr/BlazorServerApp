@using BlazorServerApp.ViewModel.Commons.Fields
@inject TooltipService TooltipService
@inject DialogService DialogService

<div class="rz-mb-3">
    @if (!string.IsNullOrEmpty(Field?.Label))
    {
        <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 8px;">
            <RadzenText TextStyle="TextStyle.Subtitle2" Style="margin: 0; line-height: 1;">@Field.Label</RadzenText>
            @if (!string.IsNullOrEmpty(Field?.Hint))
            {
                <RadzenIcon Icon="info" Style="cursor: help; color: var(--rz-text-tertiary-color); font-size: 18px; line-height: 1;"
                            MouseEnter="@(args => ShowHintTooltip(args))" />
            }
            <RadzenIcon Icon="open_in_full" @onclick="OpenInDialog"
                        Style="cursor: pointer; color: var(--rz-text-tertiary-color); font-size: 18px; line-height: 1;"
                        MouseEnter="@(args => TooltipService.Open(args, "Open in dialog"))" />
        </div>
    }

    <RadzenHtmlEditor @bind-Value="@_htmlValue"
                      Style="@($"height: {Field?.Height ?? "450px"};")"
                      Disabled="@(Field?.ReadOnly ?? false)"
                      Change="@OnChange"
                      UploadUrl="@Field?.UploadUrl" />
</div>

@if (!string.IsNullOrEmpty(Field?.Error))
{
    <RadzenAlert AlertStyle="AlertStyle.Danger"
                 Shade="Shade.Lighter"
                 Size="AlertSize.Small"
                 AllowClose="false"
                 class="rz-mt-1">
        @Field.Error
    </RadzenAlert>
}

@if (!string.IsNullOrEmpty(Field?.Warning))
{
    <RadzenAlert AlertStyle="AlertStyle.Warning"
                 Shade="Shade.Lighter"
                 Size="AlertSize.Small"
                 AllowClose="false"
                 class="rz-mt-1">
        @Field.Warning
    </RadzenAlert>
}

@code {
    [Parameter]
    public HtmlFieldViewModel? Field { get; set; }

    [Parameter]
    public EventCallback<string> ValueChanged { get; set; }

    private string? _htmlValue;
    private string? _dialogHtmlValue;

    protected override void OnParametersSet()
    {
        _htmlValue = Field?.Value;
    }

    private async Task OnChange(string html)
    {
        _htmlValue = html;
        if (Field != null)
        {
            Field.Value = html ?? string.Empty;
            await ValueChanged.InvokeAsync(html ?? string.Empty);
        }
    }

    private async Task OpenInDialog()
    {
        _dialogHtmlValue = _htmlValue;

        var result = await DialogService.OpenAsync(Field?.Label ?? "HTML Editor", ds =>
            @<div style="display: flex; flex-direction: column; min-height: 0; height: 100%;">
                <RadzenHtmlEditor Value="@_dialogHtmlValue"
                                  Change="@(v => _dialogHtmlValue = v)"
                                  Style="flex: 1;"
                                  Disabled="@(Field?.ReadOnly ?? false)"
                                  UploadUrl="@Field?.UploadUrl" />
                <div style="display: flex; justify-content: flex-end; margin-top: 8px;">
                    <RadzenButton Text="OK" ButtonStyle="ButtonStyle.Primary" Click="() => ds.Close(true)" />
                </div>
            </div>,
            new DialogOptions
            {
                Resizable = true,
                Draggable = true,
                Width = "90%",
                Height = "90vh",
                CloseDialogOnOverlayClick = true
            });

        if (result is true)
        {
            await OnChange(_dialogHtmlValue ?? string.Empty);
        }
    }

    private void ShowHintTooltip(ElementReference elementReference)
    {
        if (!string.IsNullOrEmpty(Field?.Hint))
        {
            TooltipService.Open(elementReference, Field.Hint);
        }
    }
}
